import logging
from datetime import datetime, timedelta
from database import AsyncSessionLocal, Notification
from sqlalchemy import select

logger = logging.getLogger(__name__)

class NotificationManager:
    def __init__(self, bot):
        self.bot = bot
    
    async def schedule_collection_reminders(self, user_id: int, collection_date: datetime):
        """–ü–ª–∞–Ω–∏—Ä—É–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Å–±–æ—Ä–µ –∞–Ω–∞–ª–∏–∑–æ–≤"""
        reminders = [
            (timedelta(hours=-0.5), "06:30", "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! ‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞—é, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è –≤—ã –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª–∏ —Å–±–æ—Ä –∞–Ω–∞–ª–∏–∑–æ–≤! –ß–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—é –≤–∞–º –ø–µ—Ä–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ."),
            (timedelta(hours=0), "07:00", "üß™ –í–æ–∑—å–º–∏—Ç–µ –ø—Ä–æ–±–∏—Ä–∫—É ‚Ññ1. –°–æ–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–≤—É—é –ø—Ä–æ–±—É –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.\nüö´ –ù–µ –µ—Å—Ç—å, –Ω–µ –ø–∏—Ç—å, –Ω–µ —á–∏—Å—Ç–∏—Ç—å –∑—É–±—ã, –Ω–µ –¥–µ–ª–∞—Ç—å –∑–∞—Ä—è–¥–∫—É, –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –¥—É—à.\nüßò –ü–µ—Ä–µ–¥ —Å–±–æ—Ä–æ–º –ø–æ—Å–∏–¥–µ—Ç—å —Å–ø–æ–∫–æ–π–Ω–æ 10 –º–∏–Ω—É—Ç, —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è.\n‚ùÑÔ∏è –°—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–±–æ—Ä–∞ —É–±–µ—Ä–∏—Ç–µ —É–ø–∞–∫–æ–≤–∫—É –¥–ª—è –ø—Ä–æ–±–∏—Ä–æ–∫ –≤ –¥–æ–º–∞—à–Ω—é—é –º–æ—Ä–æ–∑–∏–ª—å–Ω—É—é –∫–∞–º–µ—Ä—É –∏ –ø–æ–ª–æ–∂–∏—Ç–µ —Ç—É–¥–∞ –ø–µ—Ä–≤—É—é –ø—Ä–æ–±–∏—Ä–∫—É."),
            (timedelta(hours=5), "12:00", "üß™ –í–æ–∑—å–º–∏—Ç–µ –ø—Ä–æ–±–∏—Ä–∫—É ‚Ññ2. –°–æ–±–µ—Ä–∏—Ç–µ –≤—Ç–æ—Ä—É—é –ø—Ä–æ–±—É –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.\nüçΩÔ∏è –ó–∞ 1 —á–∞—Å –¥–æ –µ–¥—ã –∏–ª–∏ —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞ –ø–æ—Å–ª–µ –µ–¥—ã.\nüö± –ù–µ –ø–∏—Ç—å –∑–∞ 15 –º–∏–Ω—É—Ç –¥–æ —Å–±–æ—Ä–∞.\nüö≠ –ù–µ –∫—É—Ä–∏—Ç—å, –Ω–µ –∂–µ–≤–∞—Ç—å –∂–≤–∞—á–∫—É.\nüèÉ‚Äç‚ôÄÔ∏è –ù–µ –¥–µ–ª–∞—Ç—å –∑–∞—Ä—è–¥–∫—É, –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –¥—É—à.\nüßò –ü–µ—Ä–µ–¥ —Å–±–æ—Ä–æ–º –ø–æ—Å–∏–¥–µ—Ç—å —Å–ø–æ–∫–æ–π–Ω–æ 10 –º–∏–Ω—É—Ç, —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è.\n‚ùÑÔ∏è –°—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–±–æ—Ä–∞ –ø–æ–º–µ—Å—Ç–∏—Ç—å –ø—Ä–æ–±–∏—Ä–∫—É –≤ —É–ø–∞–∫–æ–≤–∫—É –¥–ª—è –ø—Ä–æ–±–∏—Ä–æ–∫."),
            (timedelta(hours=10), "17:00", "üß™ –í–æ–∑—å–º–∏—Ç–µ –ø—Ä–æ–±–∏—Ä–∫—É ‚Ññ3. –°–æ–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ—Ç—å—é –ø—Ä–æ–±—É –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.\nüçΩÔ∏è –ó–∞ 1 —á–∞—Å –¥–æ –µ–¥—ã –∏–ª–∏ —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞ –ø–æ—Å–ª–µ –µ–¥—ã.\nüö± –ù–µ –ø–∏—Ç—å –∑–∞ 15 –º–∏–Ω—É—Ç –¥–æ —Å–±–æ—Ä–∞.\nüö≠ –ù–µ –∫—É—Ä–∏—Ç—å, –Ω–µ –∂–µ–≤–∞—Ç—å –∂–≤–∞—á–∫—É.\nüíÜ –ò–∑–±–µ–≥–∞—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –Ω–∞–≥—Ä—É–∑–æ–∫ –∑–∞ 30 –º–∏–Ω—É—Ç –¥–æ —Å–±–æ—Ä–∞.\nüßò –ü–µ—Ä–µ–¥ —Å–±–æ—Ä–æ–º –ø–æ—Å–∏–¥–µ—Ç—å —Å–ø–æ–∫–æ–π–Ω–æ 10 –º–∏–Ω—É—Ç, —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è.\n‚ùÑÔ∏è –°—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–±–æ—Ä–∞ –ø–æ–º–µ—Å—Ç–∏—Ç—å –ø—Ä–æ–±–∏—Ä–∫—É –≤ —É–ø–∞–∫–æ–≤–∫—É –¥–ª—è –ø—Ä–æ–±–∏—Ä–æ–∫."),
            (timedelta(hours=15), "22:00", "üß™ –í–æ–∑—å–º–∏—Ç–µ –ø—Ä–æ–±–∏—Ä–∫—É ‚Ññ4. –°–æ–±–µ—Ä–∏—Ç–µ —á–µ—Ç–≤—ë—Ä—Ç—É—é –ø—Ä–æ–±—É –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.\nüçΩÔ∏è –ß–µ—Ä–µ–∑ 2 —á–∞—Å–∞ –ø–æ—Å–ª–µ —É–∂–∏–Ω–∞.\nüö± –ù–µ –ø–∏—Ç—å –∑–∞ 15 –º–∏–Ω—É—Ç –¥–æ —Å–±–æ—Ä–∞.\nüö≠ –ù–µ –∫—É—Ä–∏—Ç—å, –Ω–µ –∂–µ–≤–∞—Ç—å –∂–≤–∞—á–∫—É.\nüíÜ –ò–∑–±–µ–≥–∞—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –Ω–∞–≥—Ä—É–∑–æ–∫ –∑–∞ 30 –º–∏–Ω—É—Ç –¥–æ —Å–±–æ—Ä–∞.\nüßò –ü–µ—Ä–µ–¥ —Å–±–æ—Ä–æ–º –ø–æ—Å–∏–¥–µ—Ç—å —Å–ø–æ–∫–æ–π–Ω–æ 10 –º–∏–Ω—É—Ç, —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è.\n‚ùÑÔ∏è –°—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–±–æ—Ä–∞ –ø–æ–º–µ—Å—Ç–∏—Ç—å –ø—Ä–æ–±–∏—Ä–∫—É –≤ —É–ø–∞–∫–æ–≤–∫—É –¥–ª—è –ø—Ä–æ–±–∏—Ä–æ–∫.\nüì¶ –ù–µ –¥–æ—Å—Ç–∞–≤–∞–π—Ç–µ —É–ø–∞–∫–æ–≤–∫—É —Å –ø—Ä–æ–±–∏—Ä–∫–∞–º–∏ –∏–∑ –º–æ—Ä–æ–∑–∏–ª—å–Ω–æ–π –∫–∞–º–µ—Ä—ã –¥–æ –ø—Ä–∏–µ–∑–¥–∞ –∫—É—Ä—å–µ—Ä–∞."),
        ]
        
        async with AsyncSessionLocal() as session:
            for time_delta, time_str, message in reminders:
                reminder_time = collection_date + time_delta
                notification = Notification(
                    user_id=user_id,
                    type=f"collection_reminder_{time_str}",
                    scheduled_for=reminder_time,
                    sent=False
                )
                session.add(notification)
            
            await session.commit()
        
        logger.info(f"‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Å–±–æ—Ä–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

    async def send_notification(self, user_id: int, message: str):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
        try:
            from database import get_user_by_tg_id
            user = await get_user_by_tg_id(user_id)
            if user:
                await self.bot.send_message(user.tg_id, message, parse_mode="Markdown")
                logger.info(f"‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")
