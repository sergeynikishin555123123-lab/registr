import logging
from datetime import datetime, timedelta
from database import AsyncSessionLocal, create_notification, get_user_by_tg_id
from sqlalchemy import text

logger = logging.getLogger(__name__)

class NotificationManager:
    def __init__(self, bot):
        self.bot = bot
    
    async def schedule_collection_reminders(self, user_id: int, collection_date: datetime):
        """–ü–ª–∞–Ω–∏—Ä—É–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Å–±–æ—Ä–µ –∞–Ω–∞–ª–∏–∑–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó"""
        try:
            # –í—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
            reminders = [
                {
                    "time_delta": timedelta(minutes=-30),  # –ó–∞ 30 –º–∏–Ω—É—Ç –¥–æ –ø–µ—Ä–≤–æ–≥–æ —Å–±–æ—Ä–∞
                    "time_str": "06:30",
                    "message": "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! ‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞—é, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è –≤—ã –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª–∏ —Å–±–æ—Ä –∞–Ω–∞–ª–∏–∑–æ–≤! –ß–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—é –≤–∞–º –ø–µ—Ä–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ."
                },
                {
                    "time_delta": timedelta(hours=0),  # 07:00 - –ø–µ—Ä–≤—ã–π —Å–±–æ—Ä
                    "time_str": "07:00", 
                    "message": """üß™ –í–æ–∑—å–º–∏—Ç–µ –ø—Ä–æ–±–∏—Ä–∫—É ‚Ññ1. –°–æ–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–≤—É—é –ø—Ä–æ–±—É –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
üö´ –ù–µ –µ—Å—Ç—å, –Ω–µ –ø–∏—Ç—å, –Ω–µ —á–∏—Å—Ç–∏—Ç—å –∑—É–±—ã, –Ω–µ –¥–µ–ª–∞—Ç—å –∑–∞—Ä—è–¥–∫—É, –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –¥—É—à.
üßò –ü–µ—Ä–µ–¥ —Å–±–æ—Ä–æ–º –ø–æ—Å–∏–¥–µ—Ç—å —Å–ø–æ–∫–æ–π–Ω–æ 10 –º–∏–Ω—É—Ç, —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è.
‚ùÑÔ∏è –°—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–±–æ—Ä–∞ —É–±–µ—Ä–∏—Ç–µ —É–ø–∞–∫–æ–≤–∫—É –¥–ª—è –ø—Ä–æ–±–∏—Ä–æ–∫ –≤ –¥–æ–º–∞—à–Ω—é—é –º–æ—Ä–æ–∑–∏–ª—å–Ω—É—é –∫–∞–º–µ—Ä—É –∏ –ø–æ–ª–æ–∂–∏—Ç–µ —Ç—É–¥–∞ –ø–µ—Ä–≤—É—é –ø—Ä–æ–±–∏—Ä–∫—É."""
                },
                {
                    "time_delta": timedelta(hours=5),  # 12:00 - –≤—Ç–æ—Ä–æ–π —Å–±–æ—Ä
                    "time_str": "12:00",
                    "message": """üß™ –í–æ–∑—å–º–∏—Ç–µ –ø—Ä–æ–±–∏—Ä–∫—É ‚Ññ2. –°–æ–±–µ—Ä–∏—Ç–µ –≤—Ç–æ—Ä—É—é –ø—Ä–æ–±—É –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
üçΩÔ∏è –ó–∞ 1 —á–∞—Å –¥–æ –µ–¥—ã –∏–ª–∏ —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞ –ø–æ—Å–ª–µ –µ–¥—ã.
üö± –ù–µ –ø–∏—Ç—å –∑–∞ 15 –º–∏–Ω—É—Ç –¥–æ —Å–±–æ—Ä–∞.
üö≠ –ù–µ –∫—É—Ä–∏—Ç—å, –Ω–µ –∂–µ–≤–∞—Ç—å –∂–≤–∞—á–∫—É.
üèÉ‚Äç‚ôÄÔ∏è –ù–µ –¥–µ–ª–∞—Ç—å –∑–∞—Ä—è–¥–∫—É, –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –¥—É—à.
üßò –ü–µ—Ä–µ–¥ —Å–±–æ—Ä–æ–º –ø–æ—Å–∏–¥–µ—Ç—å —Å–ø–æ–∫–æ–π–Ω–æ 10 –º–∏–Ω—É—Ç, —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è.
‚ùÑÔ∏è –°—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–±–æ—Ä–∞ –ø–æ–º–µ—Å—Ç–∏—Ç—å –ø—Ä–æ–±–∏—Ä–∫—É –≤ —É–ø–∞–∫–æ–≤–∫—É –¥–ª—è –ø—Ä–æ–±–∏—Ä–æ–∫ (—É–ø–∞–∫–æ–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –¥–æ–º–∞—à–Ω–µ–π –º–æ—Ä–æ–∑–∏–ª—å–Ω–æ–π –∫–∞–º–µ—Ä–µ –≤–º–µ—Å—Ç–µ —Å –ø—Ä–æ–±–∏—Ä–∫–æ–π ‚Ññ1)."""
                },
                {
                    "time_delta": timedelta(hours=10),  # 17:00 - —Ç—Ä–µ—Ç–∏–π —Å–±–æ—Ä
                    "time_str": "17:00", 
                    "message": """üß™ –í–æ–∑—å–º–∏—Ç–µ –ø—Ä–æ–±–∏—Ä–∫—É ‚Ññ3. –°–æ–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ—Ç—å—é –ø—Ä–æ–±—É –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
üçΩÔ∏è –ó–∞ 1 —á–∞—Å –¥–æ –µ–¥—ã –∏–ª–∏ —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞ –ø–æ—Å–ª–µ –µ–¥—ã.
üö± –ù–µ –ø–∏—Ç—å –∑–∞ 15 –º–∏–Ω—É—Ç –¥–æ —Å–±–æ—Ä–∞.
üö≠ –ù–µ –∫—É—Ä–∏—Ç—å, –Ω–µ –∂–µ–≤–∞—Ç—å –∂–≤–∞—á–∫—É.
üíÜ –ò–∑–±–µ–≥–∞—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –Ω–∞–≥—Ä—É–∑–æ–∫ –∑–∞ 30 –º–∏–Ω—É—Ç –¥–æ —Å–±–æ—Ä–∞.
üßò –ü–µ—Ä–µ–¥ —Å–±–æ—Ä–æ–º –ø–æ—Å–∏–¥–µ—Ç—å —Å–ø–æ–∫–æ–π–Ω–æ 10 –º–∏–Ω—É—Ç, —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è.
‚ùÑÔ∏è –°—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–±–æ—Ä–∞ –ø–æ–º–µ—Å—Ç–∏—Ç—å –ø—Ä–æ–±–∏—Ä–∫—É –≤ —É–ø–∞–∫–æ–≤–∫—É –¥–ª—è –ø—Ä–æ–±–∏—Ä–æ–∫ (—É–ø–∞–∫–æ–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –¥–æ–º–∞—à–Ω–µ–π –º–æ—Ä–æ–∑–∏–ª—å–Ω–æ–π –∫–∞–º–µ—Ä–µ –≤–º–µ—Å—Ç–µ —Å –ø—Ä–æ–±–∏—Ä–∫–∞–º–∏ ‚Ññ1 –∏ 2)."""
                },
                {
                    "time_delta": timedelta(hours=15),  # 22:00 - —á–µ—Ç–≤–µ—Ä—Ç—ã–π —Å–±–æ—Ä
                    "time_str": "22:00",
                    "message": """üß™ –í–æ–∑—å–º–∏—Ç–µ –ø—Ä–æ–±–∏—Ä–∫—É ‚Ññ4. –°–æ–±–µ—Ä–∏—Ç–µ —á–µ—Ç–≤—ë—Ä—Ç—É—é –ø—Ä–æ–±—É –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
üçΩÔ∏è –ß–µ—Ä–µ–∑ 2 —á–∞—Å–∞ –ø–æ—Å–ª–µ —É–∂–∏–Ω–∞.
üö± –ù–µ –ø–∏—Ç—å –∑–∞ 15 –º–∏–Ω—É—Ç –¥–æ —Å–±–æ—Ä–∞.
üö≠ –ù–µ –∫—É—Ä–∏—Ç—å, –Ω–µ –∂–µ–≤–∞—Ç—å –∂–≤–∞—á–∫—É.
üíÜ –ò–∑–±–µ–≥–∞—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –Ω–∞–≥—Ä—É–∑–æ–∫ –∑–∞ 30 –º–∏–Ω—É—Ç –¥–æ —Å–±–æ—Ä–∞.
üßò –ü–µ—Ä–µ–¥ —Å–±–æ—Ä–æ–º –ø–æ—Å–∏–¥–µ—Ç—å —Å–ø–æ–∫–æ–π–Ω–æ 10 –º–∏–Ω—É—Ç, —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è.
‚ùÑÔ∏è –°—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–±–æ—Ä–∞ –ø–æ–º–µ—Å—Ç–∏—Ç—å –ø—Ä–æ–±–∏—Ä–∫—É –≤ —É–ø–∞–∫–æ–≤–∫—É –¥–ª—è –ø—Ä–æ–±–∏—Ä–æ–∫ (—É–ø–∞–∫–æ–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –¥–æ–º–∞—à–Ω–µ–π –º–æ—Ä–æ–∑–∏–ª—å–Ω–æ–π –∫–∞–º–µ—Ä–µ –≤–º–µ—Å—Ç–µ —Å –ø—Ä–æ–±–∏—Ä–∫–∞–º–∏ ‚Ññ1, 2 –∏ 3).
üì¶ –ù–µ –¥–æ—Å—Ç–∞–≤–∞–π—Ç–µ —É–ø–∞–∫–æ–≤–∫—É —Å –ø—Ä–æ–±–∏—Ä–∫–∞–º–∏ –∏–∑ –º–æ—Ä–æ–∑–∏–ª—å–Ω–æ–π –∫–∞–º–µ—Ä—ã –¥–æ –ø—Ä–∏–µ–∑–¥–∞ –∫—É—Ä—å–µ—Ä–∞."""
                }
            ]
            
            async with AsyncSessionLocal() as session:
                # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await session.execute(
                    text("DELETE FROM notifications WHERE user_id = :user_id AND type LIKE 'collection_reminder_%'"),
                    {"user_id": user_id}
                )
                
                # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
                for reminder in reminders:
                    reminder_time = collection_date + reminder["time_delta"]
                    
                    await create_notification(
                        user_id=user_id,
                        notification_type=f"collection_reminder_{reminder['time_str']}",
                        message=reminder["message"],
                        scheduled_for=reminder_time
                    )
                
                await session.commit()
            
            logger.info(f"‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Å–±–æ—Ä–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –Ω–∞ {collection_date}")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: {e}")
            return False

    async def schedule_followup_question(self, user_id: int, collection_date: datetime):
        """–ü–ª–∞–Ω–∏—Ä—É–µ—Ç –≤–æ–ø—Ä–æ—Å –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–±–æ—Ä–∞"""
        try:
            # –í–æ–ø—Ä–æ—Å —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–±–æ—Ä–∞ (22:15)
            followup_time = collection_date + timedelta(hours=15, minutes=15)
            
            await create_notification(
                user_id=user_id,
                notification_type="collection_followup",
                message="–£–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ 4 –ø—Ä–æ–±—ã?",
                scheduled_for=followup_time
            )
            
            logger.info(f"‚úÖ –í–æ–ø—Ä–æ—Å –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —Å–±–æ—Ä–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞: {e}")
            return False

    async def send_notification(self, user_id: int, message: str, keyboard=None):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
        try:
            user = await get_user_by_tg_id(user_id)
            if user:
                if keyboard:
                    await self.bot.send_message(
                        user.tg_id, 
                        message, 
                        parse_mode="Markdown",
                        reply_markup=keyboard
                    )
                else:
                    await self.bot.send_message(
                        user.tg_id, 
                        message, 
                        parse_mode="Markdown"
                    )
                logger.info(f"‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
                return True
            else:
                logger.error(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è")
                return False
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")
            return False

    async def send_consultation_offer(self, user_id: int):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞"""
        try:
            from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="–ß—Ç–æ —è –ø–æ–ª—É—á—É –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏?", callback_data="consultation_info")],
                [InlineKeyboardButton(text="–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ–Ω–ª–∞–π–Ω-–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é (30% —Å–∫–∏–¥–∫–∞)", callback_data="book_consultation")],
                [InlineKeyboardButton(text="–ù–∞—á–∞—Ç—å 14-–¥–Ω–µ–≤–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É", callback_data="start_program")]
            ])
            
            message = """–•–æ—Ç–∏—Ç–µ –≥–ª—É–±–∂–µ –ø–æ–Ω—è—Ç—å, —á—Ç–æ —Å—Ç–æ–∏—Ç –∑–∞ –≤–∞—à–∏–º –≥—Ä–∞—Ñ–∏–∫–æ–º —ç–Ω–µ—Ä–≥–∏–∏?

–ù–∞—à –≤—Ä–∞—á-—ç–∫—Å–ø–µ—Ä—Ç –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Å—Ç–∏ –æ–Ω–ª–∞–π–Ω-—Ä–∞–∑–±–æ—Ä –≤–∞—à–µ–≥–æ –æ—Ç—á—ë—Ç–∞ –∏ –æ–±—ä—è—Å–Ω–∏—Ç—å, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–æ–Ω, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ.

–ü–æ—Å–ª–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ —Å–º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å 14-–¥–Ω–µ–≤–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è."""
            
            await self.send_notification(user_id, message, keyboard)
            logger.info(f"‚úÖ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: {e}")
            return False

    async def send_consultation_info(self, user_id: int):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏"""
        try:
            from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ–Ω–ª–∞–π–Ω-–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é", callback_data="book_consultation")],
                [InlineKeyboardButton(text="–ü–µ—Ä–µ–π—Ç–∏ –∫ 14-–¥–Ω–µ–≤–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ", callback_data="start_program")],
                [InlineKeyboardButton(text="–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥", callback_data="back_to_main")]
            ])
            
            message = """–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑–±–æ—Ä —Ü–∏—Ñ—Ä, –∞ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–æ–≥–æ, –∫–∞–∫ –∏–º–µ–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–∞—à –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∏—Ç–º.

–ù–∞ –æ–Ω–ª–∞–π–Ω-–≤—Å—Ç—Ä–µ—á–µ –≤—Ä–∞—á-—ç–∫—Å–ø–µ—Ä—Ç:
‚Ä¢ –æ–±—ä—è—Å–Ω–∏—Ç, —á—Ç–æ –∑–Ω–∞—á–∏—Ç –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å –∏ –∫–∞–∫–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏ –≤–ª–∏—è—é—Ç –Ω–∞ —Ä–∏—Ç–º —ç–Ω–µ—Ä–≥–∏–∏;
‚Ä¢ –ø–æ–º–æ–∂–µ—Ç –ø–æ–Ω—è—Ç—å, –ø–æ—á–µ–º—É –≤—ã –º–æ–∂–µ—Ç–µ —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —É—Å—Ç–∞–ª–æ—Å—Ç—å, —Ç—Ä–µ–≤–æ–≥—É –∏–ª–∏ —Å–∫–∞—á–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è;
‚Ä¢ –ø–æ–∫–∞–∂–µ—Ç, –∫–∞–∫ –≤–µ—Ä–Ω—É—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å —Å–Ω–∞, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è;
‚Ä¢ –ø–æ–¥–±–µ—Ä—ë—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ –¥–ª—è –º—è–≥–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.

–ü–æ—Å–ª–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –≤—ã:
‚Ä¢ –ø–æ–ª—É—á–∏—Ç–µ –ø–æ–Ω—è—Ç–Ω—É—é —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É –æ—Ç—á—ë—Ç–∞
‚Ä¢ –ø–æ–π–º—ë—Ç–µ, –≤ –∫–∞–∫–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–µ–π—á–∞—Å –≤–∞—à –æ—Ä–≥–∞–Ω–∏–∑–º
‚Ä¢ —Å–º–æ–∂–µ—Ç–µ —Å—Ä–∞–∑—É –ø–µ—Ä–µ–π—Ç–∏ –≤ 14-–¥–Ω–µ–≤–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É —Å –≥–æ—Ç–æ–≤—ã–º–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏.

–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è ‚Äî —ç—Ç–æ –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ä—Ç –∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é —ç–Ω–µ—Ä–≥–∏–∏ –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è."""
            
            await self.send_notification(user_id, message, keyboard)
            logger.info(f"‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: {e}")
            return False

    async def process_pending_notifications(self):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–∂–∏–¥–∞—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"""
        try:
            from database import get_pending_notifications, mark_notification_sent
            
            pending_notifications = await get_pending_notifications()
            
            for notification in pending_notifications:
                notification_id = notification.id
                user_id = notification.user_id
                message = notification.message
                notification_type = notification.type
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                success = await self.send_notification(user_id, message)
                
                if success:
                    # –û—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ
                    await mark_notification_sent(notification_id)
                    
                    # –î–ª—è followup —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
                    if notification_type == "collection_followup":
                        from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
                        keyboard = InlineKeyboardMarkup(inline_keyboard=[
                            [InlineKeyboardButton(text="–î–∞", callback_data="collected_yes")],
                            [InlineKeyboardButton(text="–°–æ–±—Ä–∞—Ç—å –Ω–µ —É–¥–∞–ª–æ—Å—å", callback_data="collected_no")]
                        ])
                        await self.send_notification(user_id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å:", keyboard)
                
                logger.info(f"üîî –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ {notification_id} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
                
            logger.info(f"‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {len(pending_notifications)} –æ–∂–∏–¥–∞—é—â–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π")
            return len(pending_notifications)
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–∂–∏–¥–∞—é—â–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: {e}")
            return 0

    async def notify_collection_success(self, user_id: int):
        """–£–≤–µ–¥–æ–º–ª—è–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –æ–± —É—Å–ø–µ—à–Ω–æ–º —Å–±–æ—Ä–µ"""
        try:
            from managers import manager_bot
            user = await get_user_by_tg_id(user_id)
            if user and manager_bot:
                await manager_bot.notify_managers(
                    f"‚úÖ –°–æ–±—Ä–∞–Ω–æ, –≥–æ—Ç–æ–≤ –∫ –∫—É—Ä—å–µ—Ä—É. –°–≤—è–∑–∞—Ç—å—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º: {user.first_name} (@{user.username})"
                )
                logger.info(f"‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω –æ–± —É—Å–ø–µ—à–Ω–æ–º —Å–±–æ—Ä–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
                return True
            return False
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –æ–± —É—Å–ø–µ—à–Ω–æ–º —Å–±–æ—Ä–µ: {e}")
            return False

    async def notify_collection_failure(self, user_id: int):
        """–£–≤–µ–¥–æ–º–ª—è–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –æ –Ω–µ—É–¥–∞—á–Ω–æ–º —Å–±–æ—Ä–µ"""
        try:
            from managers import manager_bot
            user = await get_user_by_tg_id(user_id)
            if user and manager_bot:
                await manager_bot.notify_managers(
                    f"‚ö†Ô∏è –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–ª, –Ω–æ –Ω–µ —Å–æ–±—Ä–∞–ª. –û—Ç–ª–æ–∂–∏–ª —Å–±–æ—Ä –Ω–∞ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å. –°–≤—è–∑–∞—Ç—å—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º: {user.first_name} (@{user.username})"
                )
                logger.info(f"‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω –æ –Ω–µ—É–¥–∞—á–Ω–æ–º —Å–±–æ—Ä–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
                return True
            return False
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –æ –Ω–µ—É–¥–∞—á–Ω–æ–º —Å–±–æ—Ä–µ: {e}")
            return False
